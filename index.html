<body>
  <button id="startBtn"
    style="position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);
           font-size:22px;padding:14px 28px;background:#00ff99;color:#000;border:none;
           border-radius:10px;cursor:pointer;z-index:10;">
    Start Camera
  </button>

  <video id="video" autoplay playsinline muted style="display:none;"></video>
  <canvas id="canvas"></canvas>

  <script>
    let detector, video, ctx, canvas;
    canvas = document.getElementById('canvas');
    ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    document.getElementById('startBtn').addEventListener('click', async () => {
      document.getElementById('startBtn').style.display = 'none';
      await initCamera();
      await initPose();
      loop();
    });

    async function initCamera() {
      video = document.getElementById('video');
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'user' },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
      video.style.display = 'block';
    }

    async function initPose() {
      detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet);
    }

    async function loop() {
      const poses = await detector.estimatePoses(video, { flipHorizontal: true });
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if (poses.length > 0) {
        const kp = poses[0].keypoints;
        ctx.fillStyle = 'lime';
        for (const p of kp) {
          if (p.score > 0.5) {
            ctx.beginPath();
            ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
            ctx.fill();
          }
        }
        const byName = Object.fromEntries(kp.map(k => [k.name, k]));
        const LHip = byName['left_hip'], LKnee = byName['left_knee'], LAnkle = byName['left_ankle'];
        if (LHip && LKnee && LAnkle) {
          const angle = calcAngle(LHip, LKnee, LAnkle);
          window.parent.postMessage(JSON.stringify({ leftKneeAngle: Math.round(angle) }), '*');
        }
      }
      requestAnimationFrame(loop);
    }

    function calcAngle(a,b,c){
      const ab = {x:a.x-b.x, y:a.y-b.y};
      const cb = {x:c.x-b.x, y:c.y-b.y};
      const dot = ab.x*cb.x + ab.y*cb.y;
      const mag = Math.hypot(ab.x,ab.y)*Math.hypot(cb.x,cb.y);
      return Math.acos(dot/(mag||1))*180/Math.PI;
    }
  </script>
</body>
